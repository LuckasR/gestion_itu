<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offres d'emploi - ERP Charcuterie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .job-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .job-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        .job-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .job-department {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .job-details {
            padding: 20px;
        }
        .detail-row {
            margin-bottom: 10px;
        }
        .detail-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            width: 120px;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-expired { background-color: #f8d7da; color: #721c24; }
        .date-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background-color: #e9ecef;
            color: #495057;
        }
        .btn-apply {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
        }
        .btn-apply:hover {
            color: white;
            transform: scale(1.05);
        }
        .expired-badge {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        .pre-wrap {
            white-space: pre-wrap; /* Respecte les sauts de ligne et les espaces */
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
            <div class="container">
                <a class="navbar-brand" href="/accueil">
                    <i class="fas fa-utensils me-2"></i>
                    ERP Charcuterie
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/accueil">Accueil</a>
                    <a class="nav-link active" href="/offres">Offres d'emploi</a>
                    <a class="nav-link" href="/contact">Contact</a>
                    <a class="nav-link" href="/connexion">
                        <i class="fas fa-sign-in-alt me-1"></i> Connexion
                    </a>
                </div>
            </div>
        </nav>

        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-primary mb-3">
                        <i class="fas fa-briefcase me-2"></i>
                        Nos Offres d'Emploi
                    </h1>
                    <p class="lead text-muted">Rejoignez notre équipe passionnée dans l'industrie de la charcuterie</p>
                </div>

                <!-- Filtres -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form th:action="@{/offres}" method="get" class="row g-3">
                            <input type="hidden" name="filtrer" value="1" />
                            <div class="col-md-3">
                                <select name="departementId" class="form-select">
                                    <option value="">Tous les départements</option>
                                    <option th:each="departement : ${departements}" 
                                            th:value="${departement.id}" 
                                            th:text="${departement.name}"
                                            th:selected="${selectedDepartement != null and selectedDepartement == departement.id}">
                                        Département
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="typeContratId" class="form-select">
                                    <option value="">Tous les contrats</option>
                                    <option th:each="typeContrat : ${type_contrats}" 
                                            th:value="${typeContrat.id}" 
                                            th:text="${typeContrat.name}"
                                            th:selected="${selectedTypeContrat != null and selectedTypeContrat == typeContrat.id}">
                                        Type de contrat
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" name="search" class="form-control" placeholder="Rechercher par titre..." th:value="${searchTerm}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i> Filtrer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Liste des annonces -->
                <div th:unless="${annonces.isEmpty()}" class="row">
                    <div th:each="annonce : ${annonces}" class="col-lg-6 col-xl-4 mb-4">
                        <div class="job-card h-100">
                            <!-- Header de la carte -->
                            <div class="job-header">
                                <div class="job-title" th:text="${annonce.title}">Titre de l'annonce</div>
                                <div class="job-department">
                                    <i class="fas fa-building me-1"></i>
                                    <span th:text="${annonce.departement?.name}">Département</span>
                                </div>
                                
                                <!-- Statut -->
                                <div class="mt-2">
                                    <span class="status-badge status-active" 
                                          th:classappend="${annonce.date_expiration != null and annonce.date_expiration.isBefore(T(java.time.LocalDate).now()) ? 'expired-badge' : ''}"
                                          th:text="${annonce.date_expiration != null and annonce.date_expiration.isBefore(T(java.time.LocalDate).now()) ? 'Expirée' : 'Active'}">
                                        Active
                                    </span>
                                </div>
                            </div>

                            <!-- Détails de l'annonce -->
                            <div class="job-details">
                                <!-- Niveau d'étude requis -->
                                <div class="detail-row">
                                    <span class="detail-label"><i class="fas fa-graduation-cap me-1"></i> Formation :</span>
                                    <span th:text="${annonce.niveau_etude?.name ?: 'Non spécifié'}">Niveau d'étude</span>
                                </div>

                                <!-- Genre -->
                                <div class="detail-row">
                                    <span class="detail-label"><i class="fas fa-venus-mars me-1"></i> Profil :</span>
                                    <span th:text="${annonce.genre?.name ?: 'Tous genres'}">Genre</span>
                                </div>

                                <!-- Type de contrat -->
                                <div class="detail-row">
                                    <span class="detail-label"><i class="fas fa-file-contract me-1"></i> Contrat :</span>
                                    <span th:text="${annonce.type_contrat?.name ?: 'Non spécifié'}">Type de contrat</span>
                                    <span th:if="${annonce.type_contrat?.durre_contrat != null}" 
                                          class="ms-2 badge bg-secondary">
                                        <span th:text="${#numbers.formatDecimal(annonce.type_contrat.durre_contrat, 0, 2)} + ' mois'">Durée</span>
                                    </span>
                                </div>

                                <!-- Description -->
                                <div class="detail-row">
                                    <span class="detail-label"><i class="fas fa-align-left me-1"></i> Mission :</span>
                                    <div class="text-muted" style="line-height: 1.5;" th:utext="${#strings.abbreviate(annonce.description ?: 'Aucune description', 150)}">
                                        Description de l'offre
                                    </div>
                                    <small class="text-primary" th:if="${#strings.length(annonce.description) > 150}">... <a href="#" data-bs-toggle="modal" th:attr="data-bs-target='#' + ${annonce.id}">Lire plus</a></small>
                                </div>

                                <!-- Dates -->
                                <div class="detail-row">
                                    <span class="detail-label"><i class="fas fa-calendar-alt me-1"></i> Publiée le :</span>
                                    <span class="date-badge">
                                        <i class="fas fa-calendar-day me-1"></i>
                                        <span th:text="${#temporals.format(annonce.date_publication, 'dd/MM/yyyy')}">Date publication</span>
                                    </span>
                                    <span th:if="${annonce.date_expiration != null}" class="date-badge ms-2">
                                        <i class="fas fa-calendar-times me-1"></i>
                                        <span th:text="${#temporals.format(annonce.date_expiration, 'dd/MM/yyyy')}">Expiration</span>
                                    </span>
                                </div>

                                <!-- Actions publiques -->
                                <div class="mt-3 pt-3 border-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <a th:href="@{/offre/{id}(id=${annonce.id})}" class="btn btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> Voir détails
                                        </a>
                                        
                                        <!-- Bouton Postuler si l'offre est ouverte, sinon afficher le statut -->
                                        <th:block th:switch="${annonce.status?.name}">
                                            <button th:case="'Ouvert'"
                                                class="btn btn-success" 
                                                th:onclick="'postuler(' + ${annonce.id} + ')'">
                                                <i class="fas fa-paper-plane me-1"></i>
                                                Postuler
                                            </button>
                                            <span th:case="*" class="badge bg-danger fs-6">
                                                <i class="fas fa-lock me-1"></i>
                                                <span th:text="${annonce.status?.name ?: 'Fermée'}">Statut</span>
                                            </span>
                                        </th:block>
                                    </div>
                                </div>

                                <!-- Modal pour cette offre (détails complets) -->
                                <div class="modal fade" 
                                     th:id="${annonce.id}" 
                                     tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header bg-primary text-white">
                                                <h5 class="modal-title" th:text="${annonce.title}">Titre</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <p><strong>Département :</strong> <span th:text="${annonce.departement?.name}">Département</span></p>
                                                        <p><strong>Formation :</strong> <span th:text="${annonce.niveau_etude?.name}">Niveau</span></p>
                                                        <p><strong>Contrat :</strong> <span th:text="${annonce.type_contrat?.name}">Type</span></p>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <p><strong>Description complète :</strong></p>
                                                        <div class="pre-wrap" th:text="${annonce.description}">Description</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                            <button type="button" class="btn btn-primary" th:if="${annonce.date_expiration == null or !annonce.date_expiration.isBefore(now)}"
                                                th:onclick="'postuler(' + ${annonce.id} + ')'">Postuler maintenant</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function postuler(id) {
            if (confirm('Voulez-vous postuler à cette offre ?')) {
                // Rediriger vers le formulaire de candidature
                window.location.href = '/candidature/create/' + id;
            }
        }
    </script>
</body>
</html>
